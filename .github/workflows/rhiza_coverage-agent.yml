name: RHIZA COVERAGE AGENT

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  issues: write

jobs:
  check-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Run tests and generate coverage
        run: |
          make test

      - name: Check Coverage and Create Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -c "
          import json
          import subprocess
          import sys
          
          try:
              with open('_tests/coverage.json') as f:
                  data = json.load(f)
              
              coverage = data['totals']['percent_covered']
              print(f'Current Coverage: {coverage:.2f}%')
              
              if coverage < 100:
                  print('Coverage is below 100%. Creating GitHub Issue...')
                  
                  title = f'Coverage Gap Detected: {coverage:.2f}%'
                  body = (
                      f'Coverage analysis detected gaps. Current coverage is {coverage:.2f}%.\n\n'
                      'Please analyze the coverage report and add tests to reach 100% coverage.\n\n'
                      '@github-actions assign to copilot'
                  )
                  
                  cmd = [
                      'gh', 'issue', 'create',
                      '--title', title,
                      '--body', body,
                      '--label', 'coverage'
                  ]
                  
                  subprocess.run(cmd, check=True)
                  print('Issue created successfully.')
              else:
                  print('Coverage is 100%. No issue needed.')
          
          except FileNotFoundError:
              print('Error: _tests/coverage.json not found. Did make test run?')
              sys.exit(1)
          except Exception as e:
              print(f'Error: {e}')
              sys.exit(1)
          "
