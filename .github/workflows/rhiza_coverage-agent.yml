name: RHIZA COVERAGE AGENT

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  issues: write

jobs:
  check-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Run tests and generate coverage
        run: |
          make test

      - name: Check Execution Conditions
        id: check
        run: |
          if [ -f "_tests/coverage.json" ]; then
            echo "has_report=true" >> $GITHUB_OUTPUT
          else
            echo "has_report=false" >> $GITHUB_OUTPUT
          fi
          
          if [ -d "tests/test_rhiza" ]; then
            echo "is_rhiza=true" >> $GITHUB_OUTPUT
          else
            echo "is_rhiza=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Coverage and Create Issue
        if: steps.check.outputs.has_report == 'true' || steps.check.outputs.is_rhiza == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HAS_REPORT: ${{ steps.check.outputs.has_report }}
          IS_RHIZA: ${{ steps.check.outputs.is_rhiza }}
        run: |
          python -c "
          import json
          import subprocess
          import sys
          import os
          
          def ensure_label(name, color, description):
              # Attempt to create label. If it fails (e.g. exists), we ignore the error.
              subprocess.run(
                  ['gh', 'label', 'create', name, '--color', color, '--description', description],
                  capture_output=True
              )

          # Ensure labels exist
          ensure_label('coverage', '0E8A16', 'Related to code coverage')
          ensure_label('chore', 'EDEDED', 'Routine tasks and maintenance')

          has_report = os.environ.get('HAS_REPORT') == 'true'
          is_rhiza = os.environ.get('IS_RHIZA') == 'true'
          
          if not has_report:
              if is_rhiza:
                  print('Rhiza repository detected. Creating issue for framework test review...')
                  title = 'Rhiza Framework Test Review Needed'
                  body = (
                      'The coverage report was not found, but this is the Rhiza repository.\n\n'
                      'Please review \`tests/test_rhiza\` and ensure the framework is sufficiently tested.\n\n'
                      '@github-actions assign to copilot'
                  )
                  cmd = [
                      'gh', 'issue', 'create',
                      '--title', title,
                      '--body', body,
                      '--label', 'coverage',
                      '--label', 'chore'
                  ]
                  subprocess.run(cmd, check=True)
                  print('Issue created successfully.')
              sys.exit(0)
          
          try:
              with open('_tests/coverage.json') as f:
                  data = json.load(f)
              
              coverage = data['totals']['percent_covered']
              print(f'Current Coverage: {coverage:.2f}%')
              
              if coverage < 100:
                  print('Coverage is below 100%. Creating GitHub Issue...')
                  
                  title = f'Coverage Gap Detected: {coverage:.2f}%'
                  body = (
                      f'Coverage analysis detected gaps. Current coverage is {coverage:.2f}%.\n\n'
                      'Please analyze the coverage report and add tests to reach 100% coverage.\n\n'
                      '@github-actions assign to copilot'
                  )
                  
                  cmd = [
                      'gh', 'issue', 'create',
                      '--title', title,
                      '--body', body,
                      '--label', 'coverage',
                      '--label', 'chore'
                  ]
                  
                  subprocess.run(cmd, check=True)
                  print('Issue created successfully.')
              else:
                  print('Coverage is 100%. No issue needed.')
          
          except Exception as e:
              print(f'Error: {e}')
              sys.exit(1)
          "
