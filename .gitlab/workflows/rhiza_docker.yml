# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: Docker (GitLab CI)
#
# Purpose: Lint Dockerfile with hadolint and build the image
#
# This workflow runs on pushes and merge requests. It performs two main tasks:
#  - Lints docker/Dockerfile using hadolint (fails the job on lint errors)
#  - Builds the container image with Docker Buildx to ensure the Dockerfile is valid
#
# Notes:
#  - The image is built locally for validation only; it is not pushed to any registry.

docker:lint_and_build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    - apk add --no-cache bash curl
  script:
    - |
      # Check if docker/Dockerfile exists
      if [ ! -f "docker/Dockerfile" ]; then
        echo "No docker/Dockerfile found; skipping hadolint and image build."
        exit 0
      fi
      
      # Install hadolint
      curl -sL -o /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
      chmod +x /usr/local/bin/hadolint
      
      # Lint Dockerfile
      echo "Linting docker/Dockerfile with hadolint..."
      hadolint docker/Dockerfile
      
      # Build image for validation
      echo "Building container image..."
      REPO_NAME="${CI_PROJECT_NAME}"
      REPO_NAME="${REPO_NAME//[._]/}"
      docker build \
        --file docker/Dockerfile \
        --tag "${REPO_NAME}:ci" \
        .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
