# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: Continuous Integration (GitLab CI)
#
# Purpose: Run tests on multiple Python versions to ensure compatibility.
#
# Trigger: On push and merge requests to main/master branches.

.ci_generate_matrix:
  stage: .pre
  image: python:3.12
  script:
    - python ./.rhiza/utils/version_matrix.py > matrix.json
    - cat matrix.json
  artifacts:
    paths:
      - matrix.json
    expire_in: 1 hour

ci:test:
  stage: test
  needs:
    - job: .ci_generate_matrix
      artifacts: true
  image: ghcr.io/astral-sh/uv:0.9.18-python${PYTHON_VERSION}-bookworm
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.11", "3.12", "3.13"]
  variables:
    GIT_LFS_SKIP_SMUDGE: "0"
  before_script:
    - apt-get update && apt-get install -y git-lfs
    - git lfs install
    - git lfs pull
  script:
    - echo "Testing with Python $PYTHON_VERSION"
    - export UV_EXTRA_INDEX_URL="${UV_EXTRA_INDEX_URL}"
    - uv venv --python ${PYTHON_VERSION}
    - uv sync --all-extras --frozen
    - |
      if [ -f "tests/requirements.txt" ]; then
        uv pip install -r tests/requirements.txt
      fi
    - uv pip install pytest
    - uv run pytest tests
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
