# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: Marimo Notebooks (GitLab CI)
#
# Purpose: This workflow discovers and executes all Marimo notebooks in the
#          repository. It builds a dynamic matrix to run each notebook in
#          parallel to surface errors early and keep notebooks reproducible.
#
# Trigger: This workflow runs on every push and on merge requests to main/master
#          branches (including from forks)
#
# Components:
#   - üîé Discover notebooks in book/marimo
#   - üß™ Generate child pipeline using Jinja templates
#   - ‚úÖ Trigger child pipeline to run notebooks in parallel

########################################
# 1Ô∏è‚É£ Discover notebooks
########################################
marimo:_list_notebooks:
  stage: .pre
  image: alpine:latest
  script:
    - apk add --no-cache bash jq
    - NOTEBOOK_DIR="book/marimo"
    - echo "Searching notebooks in: $NOTEBOOK_DIR"
    - |
      if [ ! -d "$NOTEBOOK_DIR" ]; then
        echo "Directory $NOTEBOOK_DIR does not exist. Setting empty matrix."
        echo "[]" > notebook_matrix.json
        exit 0
      fi

      NOTEBOOKS=$(find "$NOTEBOOK_DIR" -maxdepth 1 -type f -name "*.py" | sort)
      if [ -z "$NOTEBOOKS" ]; then
        echo "No notebooks found in $NOTEBOOK_DIR."
        echo "[]" > notebook_matrix.json
      else
        echo "$NOTEBOOKS" | jq -R -s -c 'split("\n")[:-1]' > notebook_matrix.json
      fi

      echo "Notebook matrix:"
      cat notebook_matrix.json
  artifacts:
    paths:
      - notebook_matrix.json
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

########################################
# 2Ô∏è‚É£ Generate child pipeline using Jinja
########################################
marimo:_generate_child_pipeline:
  stage: .pre
  needs:
    - job: marimo:_list_notebooks
      artifacts: true
  image: python:3.12-slim
  script:
    - pip install jinja2-cli
    - NOTEBOOKS=$(cat notebook_matrix.json | jq -r '.[]')
    - CHILD_FILE="child-pipeline.yml"
    - echo "stages: [test]" > "$CHILD_FILE"
    - |
      if [ "$NOTEBOOKS" = "[]" ]; then
        echo "# No notebooks to run" >> "$CHILD_FILE"
        exit 0
      fi
    - for notebook in $NOTEBOOKS; do JOB_NAME=$(basename "$notebook" .py | tr -c '[:alnum:]' '_'); jinja2 .gitlab/templates/marimo_job_template.yml NOTEBOOK="$notebook" JOB_NAME="$JOB_NAME" >> "$CHILD_FILE"; done
    - cat "$CHILD_FILE"
  artifacts:
    paths:
      - child-pipeline.yml
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

########################################
# 3Ô∏è‚É£ Trigger child pipeline
########################################
marimo:test_notebooks:
  stage: test
  needs:
    - job: marimo:_generate_child_pipeline
      artifacts: true
  trigger:
    include:
      - artifact: child-pipeline.yml
        job: marimo:_generate_child_pipeline
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
