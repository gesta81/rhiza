# .gitlab/workflows/rhiza_marimo.yml
# Hybrid dynamic + template workflow for Marimo notebooks

########################################
# 1️⃣ Discover notebooks
########################################
marimo:_list_notebooks:
  stage: .pre
  image: alpine:latest
  script:
    - apk add --no-cache bash jq
    - NOTEBOOK_DIR="book/marimo"
    - 'echo "Searching notebooks in: $NOTEBOOK_DIR"'
    - |
      if [ ! -d "$NOTEBOOK_DIR" ]; then
        echo "Directory $NOTEBOOK_DIR does not exist. Setting empty matrix."
        echo "[]" > notebook_matrix.json
        exit 0
      fi

      NOTEBOOKS=$(find "$NOTEBOOK_DIR" -maxdepth 1 -type f -name "*.py" | sort)
      if [ -z "$NOTEBOOKS" ]; then
        echo "No notebooks found in $NOTEBOOK_DIR."
        echo "[]" > notebook_matrix.json
      else
        echo "$NOTEBOOKS" | jq -R -s -c 'split("\n")[:-1]' > notebook_matrix.json
      fi

      echo "Notebook matrix:"
      cat notebook_matrix.json
  artifacts:
    paths:
      - notebook_matrix.json
    expire_in: 1 hour

########################################
# 2️⃣ Generate child pipeline from template
########################################
marimo:_generate_child_pipeline:
  stage: .pre
  needs:
    - job: marimo:_list_notebooks
      artifacts: true
  image: python:3.12-slim
  script:
    - pip install jinja2-cli
    - NOTEBOOKS=$(cat notebook_matrix.json | jq -r '.[]')
    - CHILD_FILE="child-pipeline.yml"
    - |
      if [ "$NOTEBOOKS" = "[]" ]; then
        echo "# No notebooks to run" >> "$CHILD_FILE"
        exit 0
      fi
    - |
      for notebook in $NOTEBOOKS; do
        JOB_NAME=$(basename "$notebook" .py | tr -c '[:alnum:]' '_')
        jinja2 .gitlab/templates/marimo_job_template.yml NOTEBOOK="$notebook" JOB_NAME="$JOB_NAME" >> "$CHILD_FILE"
      done
    - echo "Generated child pipeline:"
    - cat "$CHILD_FILE"
  artifacts:
    paths:
      - child-pipeline.yml
    expire_in: 1 hour

########################################
# 3️⃣ Trigger child pipeline
########################################
marimo:test_notebooks:
  stage: test
  needs:
    - job: marimo:_generate_child_pipeline
      artifacts: true
  trigger:
    include:
      - artifact: child-pipeline.yml
        job: marimo:_generate_child_pipeline
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
