# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: Marimo Notebooks (GitLab CI)
#
# Purpose: This workflow discovers and executes all Marimo notebooks in the
#          repository. It builds a dynamic matrix to run each notebook in
#          parallel to surface errors early and keep notebooks reproducible.
#
# Trigger: This workflow runs on every push and on merge requests to main/master
#          branches (including from forks)
#
# Components:
#   - ðŸ”Ž Discover notebooks in book/marimo
#   - ðŸ§ª Run each notebook in parallel using a matrix strategy
#   - âœ… Fail-fast disabled to report all failing notebooks

.marimo_list_notebooks:
  stage: .pre
  image: alpine:latest
  script:
    - apk add --no-cache bash jq
    - |
      NOTEBOOK_DIR="book/marimo"
      echo "Searching notebooks in: $NOTEBOOK_DIR"
      
      # Check if directory exists
      if [ ! -d "$NOTEBOOK_DIR" ]; then
        echo "Directory $NOTEBOOK_DIR does not exist. Setting empty matrix."
        echo "[]" > notebook_matrix.json
        exit 0
      fi
      
      # Find notebooks and handle empty results
      if [ -z "$(find "$NOTEBOOK_DIR" -maxdepth 1 -name "*.py" 2>/dev/null)" ]; then
        echo "No notebooks found in $NOTEBOOK_DIR. Setting empty matrix."
        echo "[]" > notebook_matrix.json
      else
        find "$NOTEBOOK_DIR" -maxdepth 1 -name "*.py" -print0 | \
          xargs -0 -n1 echo | \
          jq -R -s -c 'split("\n")[:-1]' > notebook_matrix.json
      fi
      
      echo "Notebook matrix:"
      cat notebook_matrix.json
  artifacts:
    paths:
      - notebook_matrix.json
    expire_in: 1 hour

marimo:test_notebooks:
  stage: test
  needs:
    - job: .marimo_list_notebooks
      artifacts: true
  image: ghcr.io/astral-sh/uv:0.9.18-python3.12-bookworm
  variables:
    GIT_LFS_SKIP_SMUDGE: "0"
  parallel:
    matrix:
      - NOTEBOOK: ["dummy"]  # Will be overridden by dynamic child pipeline
  before_script:
    - apt-get update && apt-get install -y git-lfs jq
    - git lfs install
    - git lfs pull
    - |
      # Read notebooks from artifact
      NOTEBOOKS=$(cat notebook_matrix.json)
      if [ "$NOTEBOOKS" = "[]" ]; then
        echo "No notebooks to test, skipping"
        exit 0
      fi
  script:
    - |
      # This job uses a workaround for GitLab CI's limited dynamic parallel matrix support
      # In practice, you would generate a child pipeline or iterate through notebooks
      NOTEBOOKS=$(cat notebook_matrix.json | jq -r '.[]')
      for notebook in $NOTEBOOKS; do
        echo "Running notebook: $notebook"
        uvx uv run "$notebook"
      done
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
  allow_failure: false
