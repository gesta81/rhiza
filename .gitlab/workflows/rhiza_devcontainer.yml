# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Devcontainer CI Workflow (GitLab CI)
#
# Purpose:
#   Validates that the devcontainer image builds successfully when devcontainer-related
#   files are changed. This workflow does NOT publish/push the image to any registry.
#
# Trigger Conditions:
#   - Push to any branch when files in .devcontainer/ change
#   - Merge requests to main/master when files in .devcontainer/ change
#   - Changes to this workflow file itself
#
# Image Configuration:
#   - Registry: Defaults to registry.gitlab.com (override with DEVCONTAINER_REGISTRY variable)
#   - Image name: {registry}/{group}/{repository}/devcontainer
#   - Image tag: {branch}-{commit-sha} (e.g., main-abc123def456)
#   - Config file: Always .devcontainer/devcontainer.json
#
# Safeguards:
#   - Checks if .devcontainer/devcontainer.json exists before building
#   - Skips gracefully with a warning if devcontainer.json is not found
#   - Converts repository owner to lowercase for Docker compatibility
#
# Publishing:
#   Publishing only happens during releases via rhiza_release.yml when the
#   PUBLISH_DEVCONTAINER repository variable is set to "true".

devcontainer:build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    - apk add --no-cache bash jq curl nodejs npm
    - npm install -g @devcontainers/cli
  script:
    - |
      # Check if devcontainer.json exists
      if [ ! -f ".devcontainer/devcontainer.json" ]; then
        echo "⚠️ No .devcontainer/devcontainer.json found, skipping build"
        exit 0
      fi
      
      # Set registry
      REGISTRY="${DEVCONTAINER_REGISTRY:-registry.gitlab.com}"
      echo "Using registry: $REGISTRY"
      
      # Login to container registry
      echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$REGISTRY"
      
      # Get lowercase repository path
      REPO_PATH_LC=$(echo "$CI_PROJECT_PATH" | tr '[:upper:]' '[:lower:]')
      
      # Get image name component
      if [ -z "$DEVCONTAINER_IMAGE_NAME" ]; then
        REPO_NAME_LC=$(echo "$CI_PROJECT_NAME" | tr '[:upper:]' '[:lower:]')
        REPO_NAME_SANITIZED=$(echo "$REPO_NAME_LC" | sed 's/^[._-]*//; s/[._-][._-]*/-/g')
        IMAGE_NAME="$REPO_NAME_SANITIZED/devcontainer"
        echo "Using default image name component: $IMAGE_NAME"
      else
        IMAGE_NAME="$DEVCONTAINER_IMAGE_NAME"
        echo "Using custom image name component: $IMAGE_NAME"
      fi
      
      # Validate image name
      if ! echo "$IMAGE_NAME" | grep -qE '^[a-z0-9]+([._-][a-z0-9]+)*(/[a-z0-9]+([._-][a-z0-9]+)*)*$'; then
        echo "❌ Invalid image name component: $IMAGE_NAME"
        echo "❌ Each component must match [a-z0-9]+([._-][a-z0-9]+)* separated by /"
        exit 1
      fi
      
      # Construct full image name
      FULL_IMAGE_NAME="$REGISTRY/$REPO_PATH_LC/$IMAGE_NAME"
      SANITIZED_TAG=$(echo "$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA" | tr '/' '-')
      
      echo "✅ Final image name: $FULL_IMAGE_NAME:$SANITIZED_TAG"
      
      # Build devcontainer (without pushing)
      devcontainer build \
        --workspace-folder . \
        --config .devcontainer/devcontainer.json \
        --image-name "$FULL_IMAGE_NAME:$SANITIZED_TAG"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - ".devcontainer/**/*"
        - ".gitlab/workflows/rhiza_devcontainer.yml"
    - if: $CI_COMMIT_BRANCH
      changes:
        - ".devcontainer/**/*"
        - ".gitlab/workflows/rhiza_devcontainer.yml"
